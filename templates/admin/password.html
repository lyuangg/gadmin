[[define "content"]]
<el-card shadow="never">
    <template #header>
        <span>修改密码</span>
    </template>
    
    <el-form :model="form" label-width="100px">
        <el-form-item label="当前密码">
            <el-input v-model="form.oldPassword" type="password" placeholder="请输入当前密码" show-password @keyup.enter="handleSubmit"></el-input>
        </el-form-item>
        <el-form-item label="新密码">
            <el-input v-model="form.newPassword" type="password" placeholder="请输入新密码（至少6位）" show-password></el-input>
        </el-form-item>
        <el-form-item label="确认新密码">
            <el-input v-model="form.confirmPassword" type="password" placeholder="请再次输入新密码" show-password @keyup.enter="handleSubmit"></el-input>
        </el-form-item>
        <el-form-item>
            <el-button type="primary" @click="handleSubmit" :loading="loading">确定</el-button>
        </el-form-item>
    </el-form>
</el-card>
[[end]]

[[define "scripts"]]
<script>
// 页面特定的配置（只需要定义当前页面需要的数据和方法）
// 布局模板会自动合并此配置并挂载应用
window.pageAppConfig = {
    data() {
        return {
            // 页面特定的数据（会自动与基础配置合并）
            // 用户信息从 localStorage 获取，不再从模板传递
            loading: false,
            form: {
                oldPassword: '',
                newPassword: '',
                confirmPassword: ''
            }
        };
    },
    methods: {
        showMessage(message, type) {
            if (type === 'success') {
                ElMessage.success(message);
            } else if (type === 'error') {
                ElMessage.error(message);
            } else {
                ElMessage.info(message);
            }
        },
        handleSubmit() {
            if (!this.form.oldPassword) {
                this.showMessage('请输入当前密码', 'error');
                return;
            }
            if (!this.form.newPassword) {
                this.showMessage('请输入新密码', 'error');
                return;
            }
            if (this.form.newPassword.length < 6) {
                this.showMessage('新密码长度不能少于6位', 'error');
                return;
            }
            if (this.form.newPassword !== this.form.confirmPassword) {
                this.showMessage('两次输入的新密码不一致', 'error');
                return;
            }
            
            this.loading = true;
            api.profile.changePassword(this.form.oldPassword, this.form.newPassword).then(() => {
                ElMessage.success('密码修改成功，请重新登录');
                // 清空表单
                this.form = {
                    oldPassword: '',
                    newPassword: '',
                    confirmPassword: ''
                };
                // 延迟跳转到登录页
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
            }).catch(err => {
                var msg = '密码修改失败';
                if (err.response && err.response.data) {
                    msg = err.response.data.msg || err.response.data.error || msg;
                }
                this.showMessage(msg, 'error');
            }).finally(() => {
                this.loading = false;
            });
        }
        // 注意：navigate, closeUserMenu, getUserAvatar, getUserNickname, getUserUsername, 
        // getUserRoles, getAvatar, handleAvatarError, handleLogout 等方法已经在基础配置中定义，不需要重复定义
    }
};
</script>
[[end]]

[[define "admin/password.html"]]
[[template "layouts/admin.html" .]]
[[end]]
